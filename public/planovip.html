<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Plano de Aula Mo√ßambicano</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      font-family: "Times New Roman", Times, serif;
      font-size: 12px;
      background: #eef2f5;
      padding: 20px;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    html, body {
      -webkit-touch-callout: none;
      -webkit-user-drag: none;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    h1, h2, h3 {
      text-align: center;
      color: #2b5dab;
    }
    label {
      font-weight: 700;
      margin-top: 12px;
      display: block;
    }
    input[type="text"], input[type="password"] {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 12px;
      font-family: "Times New Roman", Times, serif;
    }
    button {
      margin-top: 15px;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 15px;
    }
    .btn-azul {
      background: #2b5dab;
      color: #fff;
    }
    .btn-verde {
      background: #2e7d32;
      color: #fff;
    }
    .btn-cinza {
      background: #6c757d;
      color: #fff;
    }
    .botoes {
      text-align: center;
    }
    .pagamento-section {
      display: none;
      margin-top: 20px;
      padding: 15px;
      background: #e6f0ff;
      border: 1px solid #a0c4ff;
      border-radius: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #333;
      padding: 4px;
      vertical-align: top;
    }
    th {
      background: #e0e7ff;
      text-align: center;
    }
    .align-right {
      text-align: right;
    }
    .quadro-moral {
      font-family: "Times New Roman", Times, serif;
      font-size: 12pt;
      background: #fff;
      padding: 15px;
      border: 1px dashed #bba100;
      border-radius: 8px;
      margin-top: 30px;
      page-break-before: always;
    }
    .rodape {
      text-align: center;
      font-style: italic;
      margin-top: 30px;
      color: #555;
    }
    textarea {
      width: 100%;
      min-height: 150px;
      font-family: "Times New Roman", Times, serif;
      font-size: 12px;
      margin-top: 10px;
      padding: 10px;
    }
    .preliminares {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-top: 20px;
    }
    .loading {
      display: none;
      text-align: center;
      margin: 15px 0;
      font-weight: 700;
      color: #2b5dab;
    }
    .loading::after {
      content: " ‚è≥";
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Progresso */
    .progress-container {
      width: 100%;
      background-color: #f0f0f0;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
      display: none;
    }
    .progress-bar {
      width: 0%;
      height: 30px;
      background: linear-gradient(90deg, #2b5dab, #4a7fd4);
      border-radius: 10px;
      transition: width 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: bold;
      position: relative;
    }
    .progress-spinner {
      position: absolute;
      right: 10px;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    .progress-text {
      z-index: 1;
    }

    /* Fluxos */
    .fluxo {
      display: none;
    }
    .fluxo.ativo {
      display: block;
      animation: fadeIn 0.5s;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Novo estilo para o Fluxo 2 simplificado */
    .quadro-container {
      background: #f9fbfd;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin: 25px 0;
      position: relative;
      border: 1px solid #d0e3ff;
    }
    
    .quadro-container::before {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 5px;
      background: linear-gradient(90deg, #2b5dab, #4a7fd4);
      border-radius: 5px 5px 0 0;
    }
    
    .acao-destacada {
      background: linear-gradient(135deg, #1a4a8a, #2b5dab);
      color: white;
      font-size: 16px;
      font-weight: bold;
      padding: 14px 20px;
      margin: 20px 0;
      box-shadow: 0 4px 8px rgba(43, 93, 171, 0.3);
      border: none;
      border-radius: 8px;
      display: inline-flex;
      align-items: center;
      gap: 10px;
      transition: all 0.3s ease;
      width: 100%;
      justify-content: center;
    }
    
    .acao-destacada:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(43, 93, 171, 0.4);
    }
    
    .acao-destacada::after {
      content: "‚Üí";
      font-size: 20px;
    }
    
    .instrucoes-chat {
      background: #e3f2fd;
      border-left: 4px solid #2b5dab;
      padding: 15px;
      border-radius: 0 8px 8px 0;
      margin: 15px 0;
      font-size: 13px;
    }
    
    .visualizar-plano {
      text-align: center;
      margin: 20px 0;
    }
    
    .visualizar-plano button {
      background: #e0e7ff;
      color: #2b5dab;
      border: 1px solid #a5b4fc;
    }
    
    .visualizar-plano button:hover {
      background: #c7d2fe;
    }
    
    .plano-completo {
      margin-top: 30px;
      padding: 20px;
      border: 1px dashed #9fa8da;
      border-radius: 8px;
      background: #f5f9ff;
      display: none;
      position: relative;
    }
    
    /* Marca d'√°gua para plano n√£o pago */
    .marca-dagua {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-45deg);
      font-size: 24px;
      font-weight: bold;
      color: rgba(220, 53, 69, 0.2);
      pointer-events: none;
      white-space: nowrap;
      z-index: 1;
    }
    
    /* Quadro Moral com scroll */
    .quadro-visualizacao {
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #a0c4ff;
      border-radius: 8px;
      padding: 15px;
      margin: 20px 0;
      background: white;
      font-family: "Times New Roman", serif;
      font-size: 12pt;
      line-height: 1.5;
    }
    
    .quadro-visualizacao::-webkit-scrollbar {
      width: 8px;
    }
    
    .quadro-visualizacao::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 4px;
    }
    
    .quadro-visualizacao::-webkit-scrollbar-thumb {
      background: #2b5dab;
      border-radius: 4px;
    }
    
    .quadro-visualizacao::-webkit-scrollbar-thumb:hover {
      background: #1a4a8a;
    }
    
    .botao-gerar-pdf {
      background: linear-gradient(135deg, #283593, #3949ab);
      color: white;
      padding: 16px 32px;
      font-size: 18px;
      font-weight: bold;
      margin: 25px 0 15px;
      box-shadow: 0 6px 15px rgba(43, 93, 171, 0.4);
      border: none;
      border-radius: 10px;
      transition: all 0.3s ease;
    }
    
    .botao-gerar-pdf:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(43, 93, 171, 0.5);
    }
    
    .botao-gerar-pdf:active {
      transform: translateY(1px);
    }
    
    .botao-gerar-pdf::after {
      content: " ‚Üì";
      font-size: 20px;
    }
    
    /* Bot√µes do Quadro Moral */
    .botoes-quadro {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: center;
      margin: 15px 0 20px;
    }
    
    .btn-imagem {
      background: linear-gradient(135deg, #7b1fa2, #9c27b0);
      color: white;
      padding: 10px 15px;
      font-size: 14px;
      border-radius: 6px;
    }
    
    .btn-imagem:hover {
      background: linear-gradient(135deg, #6a1b9a, #8e24aa);
    }
    
    .preview-imagem {
      max-width: 100%;
      max-height: 200px;
      display: block;
      margin: 10px auto;
      border: 1px solid #ddd;
      border-radius: 4px;
    }
    
    @media (max-width: 768px) {
      .preliminares {
        grid-template-columns: 1fr;
      }
      .botao-gerar-pdf {
        width: 100%;
      }
      .quadro-visualizacao {
        max-height: 300px;
      }
      .botoes-quadro {
        flex-direction: column;
      }
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body oncontextmenu="return false">
  <div class="container">
    <!-- üîπ FLUXO 1: Entrada de Dados -->
    <div id="fluxo1" class="fluxo ativo">
      <h1>Plano de Aula Mo√ßambicano</h1>
      <h3 style="margin-top:-10px;color:#444;">Por Edmilson Bartolomeu Nhanombe</h3>

      <label>Nome da Escola:</label>
      <input type="text" id="escola" placeholder="Somente letras" maxlength="60" />

      <label>Data:</label>
      <input type="text" id="data" placeholder="ddmmaaaa (apenas letras e n√∫meros)" maxlength="20"/>

      <label>Nome do Professor:</label>
      <input type="text" id="professor" placeholder="Somente letras" maxlength="60" />

      <label>Disciplina:</label>
      <input type="text" id="disciplina" placeholder="Somente letras" maxlength="60" />

      <label>Classe:</label>
      <input type="text" id="classe" placeholder="M√°x 2 n√∫meros" maxlength="2" />

      <label>Unidade Tem√°tica:</label>
      <input type="text" id="unidade" placeholder="Letras e n√∫meros" maxlength="80" />

      <label>Tema da Aula:</label>
      <input type="text" id="tema" placeholder="Letras e s√≠mbolos matem√°ticos" maxlength="120" />

      <div class="preliminares">
        <div>
          <label>Turma:</label>
          <input type="text" id="turma" placeholder="1 letra" maxlength="1" />
        </div>
        <div>
          <label>N¬∫ de Alunos:</label>
          <input type="text" id="numAlunos" class="align-right" placeholder="Somente n√∫meros" maxlength="4" />
        </div>
        <div>
          <label>Per√≠odo:</label>
          <input type="text" id="periodo" placeholder="Somente letras" maxlength="30" />
        </div>
        <div>
          <label>N¬∫ de Li√ß√£o:</label>
          <input type="text" id="numLicao" placeholder="Somente n√∫meros" maxlength="4" />
        </div>
        <div>
          <label>Tipo de Aula:</label>
          <input type="text" id="tipoAula" placeholder="Somente letras" maxlength="40" />
        </div>
        <div>
          <label>Dura√ß√£o:</label>
          <input type="text" id="duracao" value="45 minutos" readonly />
        </div>
      </div>

      <div class="botoes">
        <button class="btn-azul" onclick="irParaFluxo2()">üìò Gerar Plano</button>
      </div>

      <div class="rodape">
        Graduado no IFP de Morrumbala <br/>
        <button class="btn-azul" onclick="alert('Em caso de dificuldades contacte: 876393961 ou 834890828')">Contactar Suporte</button>
        <br/><br/>
        üîó <a href="https://whatsapp.com/channel/0029VbBdJD0BFLgNjJGmUO2O" target="_blank" style="color:#2b5dab; font-weight:bold; text-decoration:none;">
          Canal de WhatsApp para mais informa√ß√µes
        </a>
      </div>
    </div>

    <!-- üîπ FLUXO 2: Quadro Moral (SIMPLIFICADO) -->
    <div id="fluxo2" class="fluxo">
      <h1>Plano de Aula Mo√ßambicano</h1>
      <h3 style="margin-top:-10px;color:#444;">Por Edmilson Bartolomeu Nhanombe</h3>

      <div class="quadro-container">
        <h2 style="text-align:center; color:#2b5dab; margin-bottom:20px;">QUADRO MORAL</h2>
        
        <!-- Bot√£o DESTACADO para Buscar Explica√ß√£o -->
        <button class="acao-destacada" onclick="buscarExplicacao()" id="botaoExplicacao">
          üîç BUSCAR EXPLICA√á√ÉO PARA O TEMA NO CHATGPT
        </button>
        
        <div class="instrucoes-chat">
          <strong>Instru√ß√µes:</strong><br>
          1. Clique no bot√£o acima para abrir o ChatGPT com o tema pr√©-preenchido<br>
          2. Copie toda a explica√ß√£o gerada<br>
          3. Cole na √°rea abaixo<br>
          4. Clique em "üíæ SALVAR COMO QUADRO MORAL" ou "üì∑ CARREGAR FOTO"
        </div>
        
        <textarea id="campoEdicaoQuadro" placeholder="Cole aqui a explica√ß√£o completa do ChatGPT (sem emojis nem s√≠mbolos)" 
          style="width:100%; min-height:200px; font-family:'Times New Roman',serif; font-size:12px; padding:10px; margin:15px 0; border:1px solid #a0c4ff; border-radius:6px; resize:vertical;"></textarea>
        
        <!-- Bot√µes do Quadro Moral -->
        <div class="botoes-quadro">
          <button class="btn-azul" onclick="salvarQuadroMoral()" style="padding:12px 25px; font-size:14px;">
            üíæ SALVAR TEXTO
          </button>
          <button class="btn-imagem" onclick="document.getElementById('inputFotoLivro').click()">
            üì∑ CARREGAR FOTO
          </button>
          <input type="file" id="inputFotoLivro" accept="image/*" style="display:none;" onchange="exibirFotoLivro(event)">
          <button class="btn-cinza" onclick="apagarExplicacao()" style="padding:12px 25px; font-size:14px;">
            üóëÔ∏è LIMPAR
          </button>
        </div>
        
        <div id="previewFotoLivro" style="text-align:center; margin:10px 0;"></div>
        
        <!-- √Årea de visualiza√ß√£o com scroll -->
        <div class="quadro-visualizacao" id="quadroVisualizacao">
          <p style="color:#666; text-align:center; margin-top:50px;">O conte√∫do aparecer√° aqui ap√≥s salvar</p>
        </div>
        
        <div class="visualizar-plano">
          <button onclick="togglePlanoCompleto()">üëÅÔ∏è VISUALIZAR PLANO N√ÉO PAGO</button>
        </div>
        
        <div id="planoCompletoSection" class="plano-completo">
          <div class="marca-dagua">PLANO N√ÉO PAGO</div>
          <div id="planoPDF"></div>
        </div>
      </div>

      <!-- Bot√£o GERAR PDF destacado -->
      <button class="botao-gerar-pdf" onclick="irParaFluxo3()">
        üì• GERAR PDF COMPLETO (PAGO)
      </button>

      <div class="botoes" style="margin-top:10px;">
        <button class="btn-azul" style="background:#666;" onclick="voltarParaFluxo1()">
          ‚Ü©Ô∏è VOLTAR E EDITAR DADOS
        </button>
      </div>
    </div>

    <!-- üîπ FLUXO 3: Gera√ß√£o de PDF -->
    <div id="fluxo3" class="fluxo">
      <h1>Plano de Aula Mo√ßambicano</h1>
      <h3 style="margin-top:-10px;color:#444;">Por Edmilson Bartolomeu Nhanombe</h3>

      <div class="pagamento-section" id="pagamentoOpcao" style="display:block;">
        <p><strong>Escolha o tipo de pagamento:</strong></p>
        <button class="btn-azul" onclick="escolherPagamento('diario')">Pagamento Di√°rio (15 MZN) - E-mola: 876393961</button>
        <button class="btn-azul" onclick="escolherPagamento('mensal')">Pagamento Mensal (150 MZN) - E-mola: 876393961</button>
        <p style="margin-top:15px;"><strong>Introduza o c√≥digo de acesso:</strong></p>
        <input type="password" id="codigoAcesso" placeholder="Digite o c√≥digo enviado (A-Z e n√∫meros)" maxlength="20" />
        <div id="mensagemCodigo" style="margin-top:8px; font-weight:bold; color:#b00;"></div>
        <div class="loading" id="loading"></div>
        <button class="btn-azul" onclick="validarCodigo()">‚úÖ Confirmar C√≥digo e Gerar PDF</button>
        <p style="margin-top: 15px; font-weight:bold;">Em caso de dificuldades contacte: 876393961 ou 834890828</p>
      </div>

      <div class="progress-container" id="progressContainer">
        <div class="progress-bar" id="progressBar">
          <span class="progress-text" id="progressText">0%</span>
          <div class="progress-spinner"></div>
        </div>
      </div>

      <div class="rodape">
        Graduado no IFP de Morrumbala <br/>
        <button class="btn-azul" onclick="alert('Em caso de dificuldades contacte: 876393961 ou 834890828')">Contactar Suporte</button>
        <br/><br/>
        üîó <a href="https://whatsapp.com/channel/0029VbBdJD0BFLgNjJGmUO2O" target="_blank" style="color:#2b5dab; font-weight:bold; text-decoration:none;">
          Canal de WhatsApp para mais informa√ß√µes
        </a>
      </div>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    let tipoPagamentoSelecionado = null;
    let imagemQuadroMoral = null;

    // ---------- Valida√ß√£o / Normaliza√ß√£o de campos ----------
    function apenasDigitosMax(el, maxLen) {
      el.value = el.value.replace(/\D/g, '').slice(0, maxLen || el.maxLength || 9999);
    }

    function apenasLetraUnica(el) {
      el.value = el.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø]/g, '').slice(0, 1);
    }

    function apenasLetras(el) {
      el.value = el.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø\s]/g, '');
    }

    function letrasENumeros(el) {
      el.value = el.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø0-9\s]/g, '');
    }

    function temaPermitido(el) {
      el.value = el.value.replace(/[^A-Za-z√Ä-√ñ√ò-√∂√∏-√ø0-9\s+\-\*\=\/\^_\(\)\{\}\[\]√ó√∑¬±‚àö%.,:;'"<>]/g, '');
    }

    function codigoConfirmacaoOnInput(el) {
      el.value = el.value.toUpperCase().replace(/[^A-Z0-9]/g, '');
    }

    function sanitizarQuadroInputRaw(str) {
      if (!str) return '';
      str = str.replace(/[\u{1F600}-\u{1F64F}]/gu, '')
               .replace(/[\u{1F300}-\u{1F5FF}]/gu, '')
               .replace(/[\u{1F680}-\u{1F6FF}]/gu, '')
               .replace(/[\u{2600}-\u{26FF}]/gu, '')
               .replace(/[\u{2700}-\u{27BF}]/gu, '');
      str = str.replace(/[^\w√Ä-√ñ√ò-√∂√∏-√ø\s0-9\.\,\;\:\?\!\-\‚Äì\‚Äî\(\)\'\"%\/\n\r]/g, '');
      return str;
    }

    // ---------- Fun√ß√µes de Navega√ß√£o ----------
    function irParaFluxo2() {
      const get = id => document.getElementById(id)?.value?.trim() || '';
      const escola = get("escola"), data = get("data"), professor = get("professor"),
            disciplina = get("disciplina"), classe = get("classe"), tema = get("tema"), unidade = get("unidade"),
            turma = get("turma"), numAlunos = get("numAlunos"), periodo = get("periodo"),
            numLicao = get("numLicao"), tipoAula = get("tipoAula");

      if (!tema) { alert("Por favor, preencha o 'Tema da Aula'."); return; }

      const planoData = { escola, data, professor, disciplina, classe, tema, unidade, turma, numAlunos, periodo, numLicao, tipoAula };
      sessionStorage.setItem("planoData", JSON.stringify(planoData));

      gerarPlanoHTML(planoData);
      
      document.getElementById("fluxo1").classList.remove("ativo");
      document.getElementById("fluxo2").classList.add("ativo");
      
      // Rolar at√© o bot√£o destacado
      setTimeout(() => {
        const botao = document.querySelector('.acao-destacada');
        if (botao) botao.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 300);
    }

    function irParaFluxo3() {
      // Verificar se o quadro moral foi preenchido
      const quadroTexto = document.getElementById("campoEdicaoQuadro").value.trim() || 
                         document.getElementById("quadroVisualizacao").innerText.trim().replace("O conte√∫do aparecer√° aqui ap√≥s salvar", "").trim();
      
      if (!quadroTexto && !imagemQuadroMoral) {
        if (!confirm("‚ö†Ô∏è O Quadro Moral est√° vazio. Deseja continuar mesmo assim?")) {
          return;
        }
      }
      
      document.getElementById("fluxo2").classList.remove("ativo");
      document.getElementById("fluxo3").classList.add("ativo");
      
      // Rolar at√© a se√ß√£o de pagamento
      setTimeout(() => {
        document.getElementById("pagamentoOpcao").scrollIntoView({ behavior: 'smooth' });
      }, 300);
    }

    function voltarParaFluxo1() {
      const planoData = JSON.parse(sessionStorage.getItem("planoData") || "{}");
      if (Object.keys(planoData).length > 0) {
        Object.entries(planoData).forEach(([id, value]) => {
          const el = document.getElementById(id);
          if (el) el.value = value;
        });
      }
      document.getElementById("fluxo2").classList.remove("ativo");
      document.getElementById("fluxo1").classList.add("ativo");
    }

    function togglePlanoCompleto() {
      const planoSection = document.getElementById("planoCompletoSection");
      const botao = event.target;
      
      if (planoSection.style.display === "block") {
        planoSection.style.display = "none";
        botao.innerHTML = "üëÅÔ∏è VISUALIZAR PLANO N√ÉO PAGO";
      } else {
        planoSection.style.display = "block";
        botao.innerHTML = "üëÅÔ∏è OCULTAR PLANO";
      }
    }

    // ---------- Gera√ß√£o do Plano ----------
    function gerarPlanoHTML(planoData) {
      const { escola, data, professor, disciplina, classe, tema, unidade, turma, numAlunos, periodo, numLicao, tipoAula } = planoData;

      const objGeral = `Desenvolver compet√™ncias relacionadas com o tema "${tema}".`;
      const objCog = `Compreender e explicar o conte√∫do sobre "${tema}".`;
      const objPsi = `Aplicar os conhecimentos sobre "${tema}".`;
      const objAfet = `Valorizar a import√¢ncia de "${tema}" no dia a dia.`;

      const conteudoPadraoTabela = [
        ["00‚Äì05 min", "Introdu√ß√£o e motiva√ß√£o", "Sauda√ß√£o e organiza√ß√£o", 
         `Sa√∫da os alunos;\nVerifica ambiente;\nApresenta o tema: ${tema}`, 
         "Responde √† sauda√ß√£o;\nAnota o tema", "Expositivo", "Quadro e giz"],
        ["05‚Äì20 min", "Media√ß√£o e assimila√ß√£o", "Explora√ß√£o do tema: " + tema, 
         "Faz perguntas;\nExplica com exemplos visuais;\nRelaciona com o quotidiano", 
         "Participa;\nRelaciona o tema;\nRegista exemplos", "Elabora√ß√£o conjunta", "Quadro e livro"],
        ["20‚Äì35 min", "Dom√≠nio e consolida√ß√£o", "Exerc√≠cios pr√°ticos", 
         "Prop√µe exerc√≠cios;\nCircula pela sala", 
         "Resolve os exerc√≠cios;\nSolicita ajuda", "Trabalho independente", "Caderno"],
        ["35‚Äì45 min", "Controlo e avalia√ß√£o", "Avalia√ß√£o", 
         "Aplica avalia√ß√£o;\nRecolhe respostas", 
         "Responde individualmente", "Trabalho independente", "Folha/caderno"]
      ];

      let tabelaHTML = '';
      conteudoPadraoTabela.forEach(linha => {
        tabelaHTML += `
          <tr>
            <td contenteditable="true">${linha[0]}</td>
            <td contenteditable="true">${linha[1]}</td>
            <td contenteditable="true">${linha[2]}</td>
            <td contenteditable="true">${linha[3].replace(/\n/g, '<br>')}</td>
            <td contenteditable="true">${linha[4].replace(/\n/g, '<br>')}</td>
            <td contenteditable="true">${linha[5]}</td>
            <td contenteditable="true">${linha[6]}</td>
          </tr>`;
      });

      document.getElementById("planoPDF").innerHTML = `
        <h2 style="text-align:center;">Plano de Aula</h2>
        <div style="display: flex; justify-content: space-between; font-family:'Times New Roman'; font-size:12px;">
          <div>
            <p><strong>Escola:</strong> ${escola}</p>
            <p><strong>Data:</strong> ${data}</p>
            <p><strong>Professor:</strong> ${professor}</p>
            <p><strong>Disciplina:</strong> ${disciplina}</p>
            <p><strong>Unidade Tem√°tica:</strong> ${unidade}</p>
            <p><strong>Tema:</strong> ${tema}</p>
            <p><strong>Tipo de Aula:</strong> ${tipoAula}</p>
          </div>
          <div style="text-align: right; min-width: 300px;">
            <p><strong>Classe:</strong> ${classe}</p>
            <p><strong>Turma:</strong> ${turma}</p>
            <p><strong>N¬∫ de Alunos:</strong> ${numAlunos}</p>
            <p><strong>Li√ß√£o n¬∫:</strong> ${numLicao}</p>
            <p><strong>Dura√ß√£o:</strong> 45 minutos</p>
            <p><strong>Per√≠odo:</strong> ${periodo}</p>
          </div>
        </div>

        <p contenteditable="true"><strong>Objetivo Geral:</strong> ${objGeral}</p>
        <p><strong>Objetivos Espec√≠ficos:</strong></p>
        <p contenteditable="true"><strong>Cognitivo:</strong> ${objCog}</p>
        <p contenteditable="true"><strong>Psicomotor:</strong> ${objPsi}</p>
        <p contenteditable="true"><strong>Afetivo:</strong> ${objAfet}</p>

        <table id="tabelaPlano" border="1" cellspacing="0" cellpadding="5" style="width:100%; border-collapse:collapse; margin-top:10px;">
          <thead>
            <tr>
              <th>TEMPO</th>
              <th>FUN√á√ïES DID√ÅCTICAS</th>
              <th>CONTE√öDOS</th>
              <th>ACTIVIDADES DO PROFESSOR</th>
              <th>ACTIVIDADES DOS ALUNOS</th>
              <th>M√âTODOS DE ENSINO</th>
              <th>MEIOS DE ENSINO</th>
            </tr>
          </thead>
          <tbody>
            ${tabelaHTML}
          </tbody>
        </table>`;
    }

    // ---------- Quadro Moral ----------
    function buscarExplicacao() {
      const botao = document.getElementById("botaoExplicacao");
      const planoData = JSON.parse(sessionStorage.getItem("planoData") || "{}");
      const tema = planoData.tema || "";
      
      if (!tema) {
        alert("‚ö†Ô∏è Tema n√£o encontrado. Por favor, volte e preencha o tema da aula.");
        return;
      }

      // Feedback visual imediato
      botao.innerHTML = "‚è≥ ABRINDO CHATGPT...";
      botao.disabled = true;
      botao.style.background = "linear-gradient(135deg, #546e7a, #78909c)";

      // Criar query espec√≠fica para contexto mo√ßambicano
      const query = `Explica o tema "${tema}" para alunos da 8¬™ classe de Mo√ßambique. Inclui:
1. Defini√ß√£o clara e simples
2. 3 exemplos pr√°ticos do quotidiano mo√ßambicano
3. 2 exerc√≠cios resolvidos
4. Uma aplica√ß√£o pr√°tica no contexto local
5. Linguagem acess√≠vel para adolescentes
N√ÉO USE emojis, marcadores como ‚úì ou ‚Ä¢, nem formata√ß√£o complexa. Use apenas texto limpo com par√°grafos curtos.`;

      const url = `https://chat.openai.com/?q=${encodeURIComponent(query)}`;
      
      // Abrir em nova janela com foco
      setTimeout(() => {
        const janelaChat = window.open(url, "_blank", "width=800,height=800");
        
        if (janelaChat) {
          janelaChat.focus();
          // Restaurar bot√£o ap√≥s 3 segundos
          setTimeout(() => {
            botao.innerHTML = "‚úÖ CHATGPT ABERTO! AGORA COLE O RESULTADO";
            botao.style.background = "linear-gradient(135deg, #2e7d32, #43a047)";
            
            // Voltar ao estado normal ap√≥s 5 segundos
            setTimeout(() => {
              botao.innerHTML = "üîÅ BUSCAR NOVAMENTE NO CHATGPT";
              botao.style.background = "linear-gradient(135deg, #5c6bc0, #7986cb)";
              botao.disabled = false;
            }, 5000);
          }, 1000);
        } else {
          botao.innerHTML = "‚ùå ERRO AO ABRIR CHATGPT";
          botao.style.background = "linear-gradient(135deg, #d32f2f, #f44336)";
          setTimeout(() => {
            botao.innerHTML = "üîÑ TENTAR NOVAMENTE";
            botao.style.background = "linear-gradient(135deg, #1a4a8a, #2b5dab)";
            botao.disabled = false;
          }, 3000);
          alert("‚ùå N√£o foi poss√≠vel abrir o ChatGPT. Verifique se o pop-up est√° bloqueado.");
        }
      }, 500);
    }

    function salvarQuadroMoral() {
      const texto = document.getElementById("campoEdicaoQuadro").value.trim();
      if (!texto) {
        alert("‚ö†Ô∏è Por favor, cole a explica√ß√£o do ChatGPT primeiro.");
        return;
      }

      const textoSanitizado = sanitizarQuadroInputRaw(texto);

      imagemQuadroMoral = null;
      
      // Mostrar no quadro com scroll
      document.getElementById("quadroVisualizacao").innerHTML = `
        <div style="text-align:center; margin-bottom:15px;">
          <strong style="color:#2b5dab; font-size:14pt;">EXPLICA√á√ÉO DO TEMA</strong>
        </div>
        <div style="text-align:left; line-height:1.6; white-space:pre-wrap;">
          ${textoSanitizado.replace(/\n/g, '<br>')}
        </div>`;
      
      // Feedback visual
      const botaoSalvar = event.target;
      botaoSalvar.innerHTML = "‚úÖ TEXTO SALVO!";
      botaoSalvar.style.background = "#2e7d32";
      
      setTimeout(() => {
        botaoSalvar.innerHTML = "üíæ SALVAR TEXTO";
        botaoSalvar.style.background = "";
      }, 2000);
      
      // Rolar at√© o quadro salvo
      document.getElementById("quadroVisualizacao").scrollIntoView({ behavior: 'smooth' });
    }

    function exibirFotoLivro(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validar tipo de arquivo
      if (!file.type.match('image.*')) {
        alert("‚ö†Ô∏è Por favor, selecione apenas arquivos de imagem.");
        return;
      }
      
      // Validar tamanho (m√°ximo 5MB)
      if (file.size > 5242880) {
        alert("‚ö†Ô∏è A imagem √© muito grande. Selecione uma imagem menor que 5MB.");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const imgData = e.target.result;
        imagemQuadroMoral = imgData;
        
        // Mostrar pr√©-visualiza√ß√£o
        const preview = document.getElementById("previewFotoLivro");
        preview.innerHTML = `
          <img src="${imgData}" class="preview-imagem" alt="Pr√©-visualiza√ß√£o da foto">
          <button class="btn-cinza" onclick="removerFoto()" style="margin-top:10px; padding:5px 10px;">
            üóëÔ∏è Remover Foto
          </button>`;
        
        // Mostrar no quadro de visualiza√ß√£o
        document.getElementById("quadroVisualizacao").innerHTML = `
          <div style="text-align:center; margin-bottom:15px;">
            <strong style="color:#2b5dab; font-size:14pt;">IMAGEM DO LIVRO</strong>
          </div>
          <div style="display:flex; justify-content:center; align-items:center; min-height:150px;">
            <img src="${imgData}" style="max-width:100%; max-height:300px; border:1px solid #ddd; border-radius:4px;">
          </div>`;
        
        // Limpar √°rea de texto
        document.getElementById("campoEdicaoQuadro").value = "";
        
        // Rolar at√© a visualiza√ß√£o
        document.getElementById("quadroVisualizacao").scrollIntoView({ behavior: 'smooth' });
      };
      reader.readAsDataURL(file);
    }

    function removerFoto() {
      imagemQuadroMoral = null;
      document.getElementById("previewFotoLivro").innerHTML = "";
      document.getElementById("quadroVisualizacao").innerHTML = `
        <p style="color:#666; text-align:center; margin-top:50px;">O conte√∫do aparecer√° aqui ap√≥s salvar</p>`;
      document.getElementById("inputFotoLivro").value = "";
    }

    function apagarExplicacao() {
      document.getElementById("campoEdicaoQuadro").value = "";
      document.getElementById("quadroVisualizacao").innerHTML = `
        <p style="color:#666; text-align:center; margin-top:50px;">O conte√∫do aparecer√° aqui ap√≥s salvar</p>`;
      document.getElementById("previewFotoLivro").innerHTML = "";
      imagemQuadroMoral = null;
      
      // Feedback visual
      alert("üóëÔ∏è Conte√∫do limpo com sucesso!");
    }

    // ---------- Gera√ß√£o de PDF ----------
    function escolherPagamento(tipo) {
      tipoPagamentoSelecionado = tipo;
      
      // Destacar bot√£o selecionado
      document.querySelectorAll('.btn-azul').forEach(btn => {
        btn.style.background = "#2b5dab";
      });
      
      event.target.style.background = "#1a4a8a";
    }

    function simularProgresso() {
      const progressContainer = document.getElementById("progressContainer");
      const progressBar = document.getElementById("progressBar");
      const progressText = document.getElementById("progressText");
      
      progressContainer.style.display = "block";
      let progress = 0;
      
      const interval = setInterval(() => {
        progress += 1;
        progressBar.style.width = progress + "%";
        progressText.textContent = progress + "%";
        
        if (progress >= 100) {
          clearInterval(interval);
        }
      }, 30);
    }

    function validarCodigo() {
      const codigoInput = document.getElementById("codigoAcesso");
      codigoConfirmacaoOnInput(codigoInput);
      const codigo = codigoInput.value.trim();
      const msg = document.getElementById("mensagemCodigo");
      const loading = document.getElementById("loading");
      msg.innerText = "";
      
      if (!codigo) {
        msg.innerText = "‚ö†Ô∏è Digite o c√≥digo de acesso.";
        return;
      }
      
      if (!tipoPagamentoSelecionado) {
        msg.innerText = "‚ö†Ô∏è Escolha primeiro o tipo de pagamento.";
        return;
      }
      
      loading.style.display = "block";
      msg.innerText = "Aguarde pela permiss√£o...";
      
      simularProgresso();

      setTimeout(() => {
        // ‚ö†Ô∏è SUBSTITUA ESTA SIMULA√á√ÉO PELA CHAMADA REAL AO APPS SCRIPT
        const mockResponse = {
          status: "ok",
          restantes: 9,
          data_final: "30/11/2025"
        };

        document.getElementById("progressContainer").style.display = "none";
        if (mockResponse.status === "ok") {
          msg.style.color = "green";
          msg.innerHTML = `‚úÖ C√≥digo v√°lido!<br>PDFs restantes: ${mockResponse.restantes}<br>V√°lido at√©: ${mockResponse.data_final}`;
          
          // Gerar o PDF automaticamente ap√≥s valida√ß√£o
          setTimeout(() => {
            baixarPDF();
            document.getElementById("fluxo3").classList.remove("ativo");
            document.getElementById("fluxo2").classList.add("ativo");
            // Mostrar mensagem de sucesso
            alert("‚úÖ PDF gerado e baixado com sucesso!");
          }, 1000);
        } else if (mockResponse.status === "expirado") {
          msg.innerText = "‚ùå C√≥digo expirado. Contacte o administrador.";
        } else if (mockResponse.status === "limite") {
          msg.innerText = "‚ùå Limite de PDFs atingido para este c√≥digo.";
        } else if (mockResponse.status === "nao_encontrado") {
          msg.innerText = "‚ùå C√≥digo n√£o encontrado. Verifique e tente novamente.";
        } else {
          msg.innerText = "‚ö†Ô∏è Ocorreu um erro na valida√ß√£o. Tente novamente.";
        }
        loading.style.display = "none";
      }, 3000);
    }

    function baixarPDF() {
      const planoDataJSON = sessionStorage.getItem("planoData");
      if (!planoDataJSON) {
        alert("‚ùå Nenhum plano encontrado. Gere o plano antes.");
        return;
      }
      const planoData = JSON.parse(planoDataJSON);
      const doc = new jsPDF({ orientation: "landscape", unit: "mm", format: "a4" });
      doc.setFont("times", "normal");
      doc.setFontSize(12);
      doc.text("Plano de Aula", 148, 12, { align: "center" });

      // Dados b√°sicos
      let yLeft = 25, yRight = 25;
      const addLine = (label, value, x, y) => {
        if (!value) value = "";
        doc.text(`${label}:`, x, y);
        doc.text(value, x + 32, y);
        return y + 6;
      };

      yLeft = addLine("Escola", planoData.escola, 10, yLeft);
      yLeft = addLine("Data", planoData.data, 10, yLeft);
      yLeft = addLine("Professor", planoData.professor, 10, yLeft);
      yLeft = addLine("Unidade Tem√°tica", planoData.unidade, 10, yLeft);
      yLeft = addLine("Tema", planoData.tema, 10, yLeft);
      yLeft = addLine("Tipo de Aula", planoData.tipoAula, 10, yLeft);

      yRight = addLine("Classe", planoData.classe, 235, yRight);
      yRight = addLine("Turma", planoData.turma, 235, yRight);
      yRight = addLine("N¬∫ de Alunos", planoData.numAlunos, 235, yRight);
      yRight = addLine("Li√ß√£o n¬∫", planoData.numLicao, 235, yRight);
      yRight = addLine("Dura√ß√£o", "45 minutos", 235, yRight);
      yRight = addLine("Per√≠odo", planoData.periodo, 235, yRight);

      let lastY = Math.max(yLeft, yRight);

      // Objetivos
      const planoPDFElement = document.getElementById("planoPDF");
      const objetivoGeralElement = planoPDFElement.querySelector('p[contenteditable="true"]:first-of-type');
      let objetivoGeralTexto = objetivoGeralElement ? objetivoGeralElement.innerText.replace("Objetivo Geral:", "").trim() : `Desenvolver compet√™ncias sobre "${planoData.tema}".`;

      doc.setFont("times", "bold");
      doc.text("Objetivo Geral:", 10, lastY + 5);
      doc.setFont("times", "normal");
      const w = doc.getTextWidth("Objetivo Geral: ");
      doc.text(objetivoGeralTexto, 10 + w, lastY + 5);
      lastY += 12;

      doc.setFont("times", "bold");
      doc.text("Objetivos Espec√≠ficos:", 10, lastY);
      doc.setFont("times", "normal");
      lastY += 6;

      const objetivosEspecificos = ["Cognitivo", "Psicomotor", "Afetivo"];
      objetivosEspecificos.forEach((tipo, index) => {
        const el = planoPDFElement.querySelectorAll('p[contenteditable="true"]')[index + 1];
        const texto = el ? el.innerText.replace(`${tipo}:`, "").trim() : "";
        doc.setFont("times", "bold");
        doc.text(`${tipo}:`, 15, lastY);
        doc.setFont("times", "normal");
        const w2 = doc.getTextWidth(`${tipo}: `);
        doc.text(texto, 15 + w2, lastY);
        lastY += 6;
      });
      lastY += 5;

      // Tabela
      const tabela = planoPDFElement.querySelector('#tabelaPlano');
      if (tabela) {
        const rows = tabela.querySelectorAll("tbody tr");
        const tableData = Array.from(rows).map(row => {
          return Array.from(row.querySelectorAll("td")).map(td => {
            let txt = td.innerText.trim();
            txt = txt.replace(/-\s*/g, "- ")
                     .replace(/\s*;\s*/g, "; ")
                     .replace(/\s+/g, " ");
            return txt;
          });
        });

        doc.autoTable({
          startY: lastY,
          head: [['TEMPO','FUN√á√ïES DID√ÅCTICAS','CONTE√öDOS','ACTIVIDADES DO PROFESSOR','ACTIVIDADES DOS ALUNOS','M√âTODOS DE ENSINO','MEIOS DE ENSINO']],
          body: tableData,
          theme: 'grid',
          styles: { 
            font: 'times', 
            fontSize: 10, 
            textColor: [0, 0, 0],
            lineWidth: 0.2,
            lineColor: [0, 0, 0],
            halign: 'left'
          },
          headStyles: { 
            fillColor: [200, 200, 200], 
            textColor: [0, 0, 0], 
            fontStyle: 'bold',
            halign: 'center',
            lineWidth: 0.2,
            lineColor: [0, 0, 0]
          },
          columnStyles: {
            0: { cellWidth: 25 },
            1: { cellWidth: 35 },
            2: { cellWidth: 40 },
            3: { cellWidth: 50 },
            4: { cellWidth: 50 },
            5: { cellWidth: 30 },
            6: { cellWidth: 30 }
          }
        });
      }

      // Quadro Moral - TEXTO AJUSTADO NO PDF
      let quadroTexto = "";
      const quadroElement = document.getElementById("quadroVisualizacao");
      if (quadroElement) {
        // Remover o texto de placeholder se existir
        const htmlContent = quadroElement.innerHTML.replace(/<p[^>]*>O conte√∫do aparecer√° aqui ap√≥s salvar<\/p>/, "");
        if (htmlContent.trim()) {
          // Extrair apenas o texto vis√≠vel
          const tempDiv = document.createElement("div");
          tempDiv.innerHTML = htmlContent;
          quadroTexto = tempDiv.textContent || tempDiv.innerText || "";
          // Remover o t√≠tulo "EXPLICA√á√ÉO DO TEMA"
          quadroTexto = quadroTexto.replace("EXPLICA√á√ÉO DO TEMA", "").trim();
        }
      }

      if (imagemQuadroMoral) {
        doc.addPage();
        doc.setFont('times', 'normal');
        doc.setFontSize(12);
        doc.text("Quadro Ilustrativo", 148, 15, null, null, 'center');
        const imgWidth = 267;
        const imgHeight = 180;
        doc.addImage(imagemQuadroMoral, 'JPEG', 15, 25, imgWidth, imgHeight, undefined, 'FAST');
      } else if (quadroTexto.trim()) {
        doc.addPage();
        doc.setFont('times', 'normal');
        doc.setFontSize(12);
        doc.setTextColor(0, 0, 0);
        doc.text("Explica√ß√£o do Tema", 148, 15, null, null, 'center');
        
        // Formata√ß√£o perfeita para o PDF
        const margin = 20;
        const pageWidth = doc.internal.pageSize.getWidth();
        const textWidth = pageWidth - 2 * margin;
        let currentY = 25;
        const lineHeight = 6;
        
        // Dividir o texto em par√°grafos
        const paragraphs = quadroTexto.split(/\n\s*\n/).filter(p => p.trim());
        
        paragraphs.forEach(paragraph => {
          const lines = doc.splitTextToSize(paragraph.trim(), textWidth);
          
          // Verificar se h√° espa√ßo para este par√°grafo
          if (currentY + (lines.length * lineHeight) > 190) {
            doc.addPage();
            doc.setFont('times', 'normal');
            doc.setFontSize(12);
            doc.text("Explica√ß√£o do Tema (continua√ß√£o)", 148, 15, null, null, 'center');
            currentY = 25;
          }
          
          // Adicionar cada linha do par√°grafo
          lines.forEach(line => {
            if (currentY > 190) {
              doc.addPage();
              currentY = 25;
            }
            doc.text(line, margin, currentY);
            currentY += lineHeight;
          });
          
          // Espa√ßo entre par√°grafos
          currentY += lineHeight;
        });
      }

      const dataFileName = planoData.data?.replace(/[\/]/g, "-") || 'sem-data';
      doc.save(`Plano_de_Aula_MZ_${dataFileName}.pdf`);
    }

    // Bloqueio de PrintScreen
    document.addEventListener("keydown", function(e) {
      if (e.key === "PrintScreen") {
        navigator.clipboard.writeText("Captura bloqueada.");
        alert("Captura de ecr√£ bloqueada.");
        e.preventDefault();
      }
    });

    // Valida√ß√µes iniciais
    document.addEventListener('DOMContentLoaded', () => {
      const validations = [
        { id: 'classe', fn: (e) => apenasDigitosMax(e.target, 2) },
        { id: 'turma', fn: (e) => apenasLetraUnica(e.target) },
        { id: 'numAlunos', fn: (e) => apenasDigitosMax(e.target) },
        { id: 'numLicao', fn: (e) => apenasDigitosMax(e.target) },
        { id: 'periodo', fn: (e) => apenasLetras(e.target) },
        { id: 'escola', fn: (e) => apenasLetras(e.target) },
        { id: 'professor', fn: (e) => apenasLetras(e.target) },
        { id: 'unidade', fn: (e) => letrasENumeros(e.target) },
        { id: 'tema', fn: (e) => temaPermitido(e.target) },
        { id: 'tipoAula', fn: (e) => apenasLetras(e.target) },
        { id: 'codigoAcesso', fn: (e) => codigoConfirmacaoOnInput(e.target) },
        { id: 'campoEdicaoQuadro', fn: (e) => { e.target.value = sanitizarQuadroInputRaw(e.target.value); } },
        { id: 'disciplina', fn: (e) => apenasLetras(e.target) }
      ];

      validations.forEach(v => {
        const el = document.getElementById(v.id);
        if (el) {
          el.addEventListener('input', v.fn);
          el.addEventListener('blur', v.fn);
        }
      });
    });
  </script>
</body>
</html>