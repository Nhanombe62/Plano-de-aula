<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Smart Lesson Plan Generator</title>
  
  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-13268422844"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-13268422844');
  </script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: "Times New Roman", Times, serif;
      font-size: 11px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 5px;
      min-height: 100vh;
      width: 100%;
      overflow-x: hidden;
    }
    
    .container {
      width: 100%;
      margin: 0 auto;
      background: white;
      padding: 10px;
      border-radius: 8px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    }
    
    h1, h2, h3 {
      color: #2b5dab;
      text-align: center;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    h1 {
      font-size: 16px;
      border-bottom: 1px solid #2b5dab;
      padding-bottom: 6px;
      margin-bottom: 15px;
    }
    
    /* Flow Navigation */
    .flow {
      display: none;
    }
    
    .flow.active {
      display: block;
    }
    
    /* Main Header Style */
    .main-header {
      text-align: center;
      margin-bottom: 15px;
      padding-bottom: 8px;
      border-bottom: 1px solid #2b5dab;
    }
    
    .creator-info {
      color: #666;
      font-style: italic;
      font-size: 11px;
    }
    
    /* Form Styles */
    .form-section {
      background: #f8f9fa;
      padding: 12px;
      border-radius: 6px;
      margin-bottom: 12px;
      border-left: 3px solid #2b5dab;
    }
    
    .section-title {
      color: #2b5dab;
      font-size: 13px;
      font-weight: bold;
      margin-bottom: 10px;
      padding-bottom: 4px;
      border-bottom: 1px solid #ccc;
    }
    
    .form-group {
      margin-bottom: 8px;
      width: 100%;
    }
    
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 3px;
      color: #333;
      font-size: 11px;
    }
    
    input[type="text"],
    textarea,
    select {
      width: 100%;
      padding: 7px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-family: "Times New Roman", Times, serif;
      font-size: 11px;
      background: white;
      color: #000000;
    }
    
    textarea {
      min-height: 70px;
      resize: vertical;
    }
    
    /* Buttons */
    .button-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 15px;
      padding-top: 12px;
      border-top: 1px solid #eee;
    }
    
    .btn {
      padding: 9px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      transition: all 0.3s;
      width: 100%;
      text-align: center;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #2b5dab, #3b82f6);
      color: white;
    }
    
    .btn-secondary {
      background: linear-gradient(135deg, #6c757d, #868e96);
      color: white;
    }
    
    .btn-success {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }
    
    .btn:active {
      transform: translateY(0);
    }
    
    /* Table Section */
    .table-section {
      margin: 15px 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 6px;
      overflow-x: auto;
    }
    
    .lesson-table {
      width: 100%;
      min-width: 550px;
      border-collapse: collapse;
      margin: 12px 0;
      font-size: 10px;
    }
    
    .lesson-table th {
      background: #2b5dab;
      color: white;
      padding: 6px 4px;
      text-align: center;
      font-weight: bold;
      font-size: 10px;
    }
    
    .lesson-table td {
      padding: 5px 4px;
      border: 1px solid #ddd;
      vertical-align: top;
    }
    
    .lesson-table input[type="text"],
    .lesson-table textarea {
      width: 100%;
      padding: 5px;
      border: 1px solid #e9ecef;
      border-radius: 3px;
      font-size: 10px;
    }
    
    .lesson-table textarea {
      min-height: 50px;
    }
    
    /* Explanation Section */
    .explanation-section {
      background: #e3f2fd;
      padding: 12px;
      border-radius: 6px;
      margin: 15px 0;
      border: 1px solid #bbdefb;
    }
    
    .explanation-controls {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 8px;
    }
    
    .explanation-textarea {
      min-height: 120px;
      font-size: 11px;
      line-height: 1.4;
      padding: 8px;
    }
    
    /* ChatGPT Button */
    .chatgpt-btn {
      background: linear-gradient(135deg, #10a37f, #1a7f64);
      color: white;
      padding: 9px 12px;
      border-radius: 4px;
      border: none;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      transition: all 0.3s;
      width: 100%;
    }
    
    /* Progress Bar */
    .progress-container {
      width: 100%;
      height: 5px;
      background: #e9ecef;
      border-radius: 3px;
      margin: 12px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #2b5dab, #3b82f6);
      width: 25%;
      transition: width 0.5s ease;
    }
    
    /* Circular Progress Overlay */
    .progress-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }
    
    .progress-circle {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: conic-gradient(#2b5dab 0%, #e9ecef 0%);
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      animation: pulse 2s infinite;
    }
    
    .progress-circle::before {
      content: '';
      position: absolute;
      width: 70px;
      height: 70px;
      background: #111;
      border-radius: 50%;
    }
    
    .progress-percent {
      color: white;
      font-size: 18px;
      font-weight: bold;
      z-index: 1;
    }
    
    .progress-text {
      color: white;
      margin-top: 15px;
      font-size: 14px;
      text-align: center;
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    /* Mobile Instructions */
    .mobile-instructions {
      display: block;
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 5px;
      padding: 8px;
      margin-bottom: 10px;
      text-align: center;
      font-size: 11px;
      color: #856404;
    }
    
    /* DESKTOP WARNING - MODIFICADO PARA APARECER APENAS EM DESKTOP */
    .desktop-warning {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.98);
      z-index: 99999;
      justify-content: center;
      align-items: center;
      text-align: center;
      color: white;
      padding: 20px;
    }
    
    /* Responsive */
    @media (max-width: 767px) {
      .container {
        display: block !important;
      }
      
      .desktop-warning {
        display: none !important;
      }
    }
    
    @media (min-width: 768px) {
      .container {
        display: none !important;
      }
      
      .desktop-warning {
        display: flex !important;
      }
      
      .desktop-warning-content {
        background: #111;
        padding: 30px;
        border-radius: 10px;
        max-width: 500px;
        border: 2px solid #ff6b6b;
      }
      
      .desktop-warning h2 {
        color: #ff6b6b;
        margin-bottom: 15px;
        font-size: 22px;
      }
      
      .desktop-warning p {
        margin-bottom: 10px;
        line-height: 1.5;
        font-size: 14px;
      }
    }
    
    /* Small phones */
    @media (max-width: 360px) {
      body {
        font-size: 10px;
        padding: 3px;
      }
      
      .container {
        padding: 8px;
      }
      
      input[type="text"],
      textarea {
        padding: 6px;
        font-size: 10px;
      }
      
      .btn {
        padding: 7px 10px;
        font-size: 11px;
      }
      
      .lesson-table {
        min-width: 500px;
        font-size: 9px;
      }
    }
    
    /* Landscape mode for mobile */
    @media (max-height: 500px) and (orientation: landscape) {
      body {
        padding: 3px;
      }
      
      .container {
        padding: 8px;
      }
      
      .form-section {
        padding: 8px;
        margin-bottom: 8px;
      }
      
      textarea {
        min-height: 50px;
      }
      
      .explanation-textarea {
        min-height: 80px;
      }
    }
  </style>
</head>
<body>
  <!-- DESKTOP WARNING -->
  <div class="desktop-warning" id="desktopWarning">
    <div class="desktop-warning-content">
      <div style="font-size: 40px; margin-bottom: 15px;">üì±</div>
      <h2>‚ö†Ô∏è ACESSO BLOQUEADO EM DESKTOP</h2>
      <p><strong>Este aplicativo √© exclusivo para dispositivos m√≥veis.</strong></p>
      <p>Por quest√µes de seguran√ßa e otimiza√ß√£o, o acesso √© permitido apenas em smartphones e tablets.</p>
      <p style="margin-top: 15px; padding: 10px; background: rgba(255, 107, 107, 0.1); border-radius: 6px; border: 1px solid #ff6b6b; font-size: 12px;">
        <strong>üìå Instru√ß√µes:</strong><br>
        1. Abra este link no seu smartphone<br>
        2. Use o aplicativo normalmente<br>
        3. Gere seu plano de aula em PDF
      </p>
      <p style="margin-top: 15px; color: #aaa; font-size: 12px;">
        Desenvolvido por Prof. Edmilson Nhanombe | IFP Morrumbala
      </p>
    </div>
  </div>

  <!-- MAIN CONTENT (visible only on mobile) -->
  <div class="container" id="mainContainer">
    <!-- Mobile Instructions -->
    <div class="mobile-instructions">
      <strong>Plano de Aula Mz</strong>
    </div>
    
    <!-- Circular Progress Overlay -->
    <div class="progress-overlay" id="progressOverlay">
      <div class="progress-circle" id="progressCircle">
        <div class="progress-percent" id="progressPercent">0%</div>
      </div>
      <div class="progress-text" id="progressText">Processing ChatGPT explanation...</div>
    </div>
    
    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <!-- Flow 1: Basic Information - LAYOUT DA IMAGEM 2 -->
    <div id="flow1" class="flow active">
      <!-- Header simplificado -->
      <div class="main-header">
        <div class="creator-info">Created by Teacher Edmilson Nhanombe Graduated from IFP of Morrumbala.</div>
      </div>
      
      <!-- SCHOOL INFORMATION Section -->
      <div class="form-section">
        <div class="section-title">SCHOOL INFORMATION</div>
        <div class="form-group">
          <label>School Name *</label>
          <input type="text" id="schoolName" placeholder="e.g., Chuiba Primary and Secondary School">
        </div>
        <div class="form-group">
          <label>Date *</label>
          <input type="text" id="date" placeholder="e.g., 14th January 2026">
        </div>
        <div class="form-group">
          <label>Teacher's Name *</label>
          <input type="text" id="teacher" placeholder="e.g., Torres Manuel Assane">
        </div>
      </div>
      
      <!-- SUBJECT DETAILS Section -->
      <div class="form-section">
        <div class="section-title">SUBJECT DETAILS</div>
        <div class="form-group">
          <label>Subject *</label>
          <input type="text" id="subject" placeholder="e.g., English Language" onchange="updateOutcomesWithTopic()">
        </div>
        <div class="form-group">
          <label>Grade/Class *</label>
          <input type="text" id="grade" placeholder="e.g., Grade 8">
        </div>
        <div class="form-group">
          <label>Lesson Type *</label>
          <input type="text" id="lessonType" placeholder="e.g., Grammar, Structure, etc.">
        </div>
        <div class="form-group">
          <label>Topic *</label>
          <input type="text" id="topic" placeholder="e.g., Question Tags, Adverbs, etc." onchange="updateOutcomesWithTopic()">
        </div>
      </div>
      
      <!-- CLASS DETAILS Section -->
      <div class="form-section">
        <div class="section-title">CLASS DETAILS</div>
        <div class="form-group">
          <label>Streams</label>
          <input type="text" id="streams" placeholder="e.g., A, B, C, D and E">
        </div>
        <div class="form-group">
          <label>Number of Students</label>
          <input type="text" id="numStudents" placeholder="e.g., 127-159">
        </div>
        <div class="form-group">
          <label>Time</label>
          <input type="text" id="time" placeholder="e.g., 1st - 6th">
        </div>
        <div class="form-group">
          <label>Period</label>
          <input type="text" id="period" placeholder="e.g., 3rd - 4th">
        </div>
        <div class="form-group">
          <label>Duration *</label>
          <input type="text" id="duration" value="45 minutes">
        </div>
      </div>
      
      <div class="button-group">
        <button class="btn btn-primary" onclick="nextFlow(2)">
          NEXT: TEACHING METHODS & MATERIALS ‚Üí
        </button>
      </div>
    </div>
    
    <!-- Flow 2: Teaching Methods & Materials -->
    <div id="flow2" class="flow">
      <h1>TEACHING METHODS & MATERIALS</h1>
      
      <div class="form-section">
        <div class="form-group">
          <label>Methods and Approaches *</label>
          <textarea id="methods" placeholder="e.g., Communicative Language Teaching (CLT); Question and Answer; Guided Discovery; Pair and Group Work">Communicative Language Teaching (CLT); Question and Answer; Guided Discovery and Pair and Group Work.</textarea>
        </div>
        
        <div class="form-group">
          <label>Suggested Materials</label>
          <input type="text" id="materials" value="Basic Teaching Materials">
        </div>
        
        <div class="form-group">
          <label>Teaching/Learning Aids (T/L Aids) *</label>
          <textarea id="aids" placeholder="List all teaching aids">Chalkboard/Whiteboard, Markers/Chalk, Flashcards and Textbook.</textarea>
        </div>
        
        <div class="form-group">
          <label>References *</label>
          <textarea id="references" placeholder="List all references">English Grade 8 Student's Book; English Grammar in Use (Elementary).</textarea>
        </div>
      </div>
      
      <div class="button-group">
        <button class="btn btn-secondary" onclick="prevFlow(1)">
          ‚Üê BACK
        </button>
        <button class="btn btn-primary" onclick="nextFlow(3)">
          NEXT: PRE-REQUISITES & OUTCOMES ‚Üí
        </button>
      </div>
    </div>
    
    <!-- Flow 3: Pre-requisites & Specific Outcomes -->
    <div id="flow3" class="flow">
      <h1>PRE-REQUISITES & SPECIFIC OUTCOMES</h1>
      
      <div class="form-section">
        <div class="form-group">
          <label>Pre-requisites *</label>
          <textarea id="prerequisites" placeholder="List the pre-requisite knowledge/skills">- Students know auxiliary verbs (is, are, do, does, did, have, will)
- Students can form simple affirmative and negative sentences
- Basic understanding of sentence structure
- Familiarity with question formation</textarea>
        </div>
        
        <div class="form-group">
          <label>Specific Outcomes *</label>
          <textarea id="outcomes" placeholder="By the end of the lesson, students should be able to:"></textarea>
        </div>
      </div>
      
      <div class="button-group">
        <button class="btn btn-secondary" onclick="prevFlow(2)">
          ‚Üê BACK
        </button>
        <button class="btn btn-success" onclick="generateLessonOutline()">
          GENERATE LESSON OUTLINE ‚Üì
        </button>
      </div>
    </div>
    
    <!-- Flow 4: Lesson Outline & Explanation -->
    <div id="flow4" class="flow">
      <h1>LESSON OUTLINE</h1>
      <p style="text-align: center; color: #666; margin-bottom: 10px; font-size: 11px;">Complete the table below with detailed activities for each stage</p>
      
      <div class="table-section">
        <table class="lesson-table">
          <thead>
            <tr>
              <th style="width: 15%;">STAGES</th>
              <th style="width: 35%;">TEACHER'S ACTIVITIES</th>
              <th style="width: 35%;">LEARNER'S ACTIVITIES</th>
              <th style="width: 15%;">TIME</th>
            </tr>
          </thead>
          <tbody id="lessonTable">
            <tr>
              <td><input type="text" value="INTRODUCTION" readonly style="font-weight: bold; text-align: center; font-size: 10px;"></td>
              <td><textarea id="introTeacher" placeholder="Teacher activities for introduction..." style="font-size: 10px;"></textarea></td>
              <td><textarea id="introStudent" placeholder="Learner activities for introduction..." style="font-size: 10px;"></textarea></td>
              <td><input type="text" value="5 min" style="text-align: center; font-size: 10px;"></td>
            </tr>
            <tr>
              <td><input type="text" value="PRESENTATION" readonly style="font-weight: bold; text-align: center; font-size: 10px;"></td>
              <td><textarea id="presentTeacher" placeholder="Teacher activities for presentation..." style="font-size: 10px;"></textarea></td>
              <td><textarea id="presentStudent" placeholder="Learner activities for presentation..." style="font-size: 10px;"></textarea></td>
              <td><input type="text" value="15 min" style="text-align: center; font-size: 10px;"></td>
            </tr>
            <tr>
              <td><input type="text" value="PRACTICE" readonly style="font-weight: bold; text-align: center; font-size: 10px;"></td>
              <td><textarea id="practiceTeacher" placeholder="Teacher activities for practice..." style="font-size: 10px;"></textarea></td>
              <td><textarea id="practiceStudent" placeholder="Learner activities for practice..." style="font-size: 10px;"></textarea></td>
              <td><input type="text" value="10 min" style="text-align: center; font-size: 10px;"></td>
            </tr>
            <tr>
              <td><input type="text" value="PRODUCTION" readonly style="font-weight: bold; text-align: center; font-size: 10px;"></td>
              <td><textarea id="productionTeacher" placeholder="Teacher activities for production..." style="font-size: 10px;"></textarea></td>
              <td><textarea id="productionStudent" placeholder="Learner activities for production..." style="font-size: 10px;"></textarea></td>
              <td><input type="text" value="10 min" style="text-align: center; font-size: 10px;"></td>
            </tr>
            <tr>
              <td><input type="text" value="CONCLUSION" readonly style="font-weight: bold; text-align: center; font-size: 10px;"></td>
              <td><textarea id="conclusionTeacher" placeholder="Teacher activities for conclusion..." style="font-size: 10px;"></textarea></td>
              <td><textarea id="conclusionStudent" placeholder="Learner activities for conclusion..." style="font-size: 10px;"></textarea></td>
              <td><input type="text" value="5 min" style="text-align: center; font-size: 10px;"></td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="explanation-section">
        <h3>GET EXPLANATION FROM CHATGPT</h3>
        <p style="margin-bottom: 10px; color: #555; font-size: 11px;">
          <strong>Instructions:</strong><br>
          1. Click "OPEN CHATGPT" - it will open ChatGPT with perfect formatting<br>
          2. Copy ALL the ChatGPT response<br>
          3. Paste below and click "PROCESS & FILL TABLE"<br>
          4. The system will automatically extract ALL teacher & learner activities
        </p>
        
        <textarea class="explanation-textarea" id="chatgptExplanation" 
                  placeholder="Paste the ENTIRE ChatGPT response here..."></textarea>
        
        <div class="explanation-controls">
          <button class="chatgpt-btn" onclick="openChatGPT()">
            <span>üîç OPEN CHATGPT</span>
          </button>
          <button class="btn btn-primary" onclick="processExplanationWithProgress()">
            ‚è≥ PROCESS & FILL ALL 10 CELLS
          </button>
          <button class="btn btn-secondary" onclick="clearAllText()">
            CLEAR ALL TEXT
          </button>
        </div>
        
        <div class="loading" id="processingLoader" style="display: none; font-size: 11px; margin-top: 5px;">Processing...</div>
      </div>
      
      <div class="button-group">
        <button class="btn btn-secondary" onclick="prevFlow(3)">
          ‚Üê BACK TO EDIT
        </button>
        <button class="btn btn-success" onclick="generatePDF()">
          üì• DOWNLOAD AS PDF
        </button>
        <button class="btn btn-primary" onclick="saveAllData()">
          üíæ SAVE LESSON PLAN
        </button>
      </div>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    let currentFlow = 1;
    
    // Google Analytics Events
    function trackEvent(category, action, label) {
      if (typeof gtag !== 'undefined') {
        gtag('event', action, {
          'event_category': category,
          'event_label': label
        });
      }
    }
    
    // Simplified device detection
    function isMobileDevice() {
      const userAgent = navigator.userAgent || navigator.vendor || window.opera;
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Mobile|mobile/i.test(userAgent);
      const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      
      return isMobile || hasTouch || window.innerWidth <= 768;
    }
    
    // Check device on load
    document.addEventListener('DOMContentLoaded', function() {
      const isMobile = isMobileDevice();
      const warningElement = document.getElementById('desktopWarning');
      const mainContainer = document.getElementById('mainContainer');
      
      if (!isMobile && window.innerWidth >= 768) {
        warningElement.style.display = 'flex';
        mainContainer.style.display = 'none';
        trackEvent('security', 'desktop_blocked', 'Desktop access blocked');
        return;
      } else {
        warningElement.style.display = 'none';
        mainContainer.style.display = 'block';
        trackEvent('device', 'mobile_access', 'Mobile access granted');
      }
      
      // Load saved data
      const savedData = localStorage.getItem('lessonPlanData');
      if (savedData) {
        try {
          const data = JSON.parse(savedData);
          for (const key in data) {
            const element = document.getElementById(key);
            if (element) {
              element.value = data[key];
            }
          }
          trackEvent('data', 'load_saved', 'Loaded saved lesson plan');
        } catch (e) {
          console.error('Error loading saved data:', e);
        }
      }
      
      // Clear table initially
      clearTable();
      
      // Auto-save on input changes
      const inputs = document.querySelectorAll('input, textarea');
      let saveTimeout;
      
      inputs.forEach(input => {
        input.addEventListener('input', function() {
          clearTimeout(saveTimeout);
          saveTimeout = setTimeout(autoSaveData, 1000);
        });
      });
      
      updateProgressBar();
      trackEvent('page', 'view', 'Lesson Plan Generator loaded');
      
      // Check on resize
      window.addEventListener('resize', function() {
        const isMobileNow = isMobileDevice();
        if (!isMobileNow && window.innerWidth >= 768) {
          warningElement.style.display = 'flex';
          mainContainer.style.display = 'none';
        }
      });
    });
    
    // Flow navigation
    function nextFlow(next) {
      if (!validateCurrentFlow(currentFlow)) {
        return;
      }
      
      trackEvent('navigation', 'next_flow', `From flow ${currentFlow} to ${next}`);
      autoSaveData();
      
      document.getElementById(`flow${currentFlow}`).classList.remove('active');
      currentFlow = next;
      document.getElementById(`flow${currentFlow}`).classList.add('active');
      updateProgressBar();
      window.scrollTo(0, 0);
    }
    
    function prevFlow(prev) {
      trackEvent('navigation', 'prev_flow', `From flow ${currentFlow} to ${prev}`);
      autoSaveData();
      
      document.getElementById(`flow${currentFlow}`).classList.remove('active');
      currentFlow = prev;
      document.getElementById(`flow${currentFlow}`).classList.add('active');
      updateProgressBar();
      window.scrollTo(0, 0);
    }
    
    // Update outcomes with topic
    function updateOutcomesWithTopic() {
      const topic = document.getElementById('topic').value || 'lesson topic';
      const subject = document.getElementById('subject').value || 'subject';
      const grade = document.getElementById('grade').value || 'Grade';
      const outcomesField = document.getElementById('outcomes');
      
      if (topic && subject && grade) {
        const defaultOutcomes = `By the end of the ${subject} lesson on "${topic}" for ${grade}, students should be able to:
1. 
2. 
3. 
4. `;
        
        if (!outcomesField.value.trim() || outcomesField.value.trim().length < 50) {
          outcomesField.value = defaultOutcomes;
        }
      }
    }
    
    // Auto-save function
    function autoSaveData() {
      const planData = collectAllData();
      localStorage.setItem('lessonPlanData', JSON.stringify(planData));
    }
    
    // Clear table function
    function clearTable() {
      const tableFields = [
        'introTeacher', 'introStudent',
        'presentTeacher', 'presentStudent',
        'practiceTeacher', 'practiceStudent',
        'productionTeacher', 'productionStudent',
        'conclusionTeacher', 'conclusionStudent'
      ];
      
      tableFields.forEach(fieldId => {
        const field = document.getElementById(fieldId);
        if (field) {
          field.value = '';
        }
      });
    }
    
    // Clear all text
    function clearAllText() {
      if (confirm('Clear ALL text including ChatGPT explanation and table content?')) {
        document.getElementById('chatgptExplanation').value = '';
        clearTable();
        trackEvent('action', 'clear_all_text', 'User cleared all text');
      }
    }
    
    function updateProgressBar() {
      const progress = (currentFlow / 4) * 100;
      document.getElementById('progressBar').style.width = `${progress}%`;
    }
    
    // Validation
    function validateCurrentFlow(flow) {
      let isValid = true;
      let message = '';
      
      if (flow === 1) {
        const required = ['schoolName', 'date', 'teacher', 'subject', 'grade', 'lessonType', 'topic', 'duration'];
        required.forEach(id => {
          const field = document.getElementById(id);
          if (!field.value.trim()) {
            field.style.borderColor = 'red';
            isValid = false;
            message = 'Please fill in all required fields marked with *';
          } else {
            field.style.borderColor = '';
          }
        });
      } else if (flow === 2) {
        const required = ['methods', 'aids', 'references'];
        required.forEach(id => {
          const field = document.getElementById(id);
          if (!field.value.trim()) {
            field.style.borderColor = 'red';
            isValid = false;
            message = 'Please fill in all required fields';
          } else {
            field.style.borderColor = '';
          }
        });
      } else if (flow === 3) {
        const required = ['prerequisites', 'outcomes'];
        required.forEach(id => {
          const field = document.getElementById(id);
          if (!field.value.trim()) {
            field.style.borderColor = 'red';
            isValid = false;
            message = 'Please fill in all required fields';
          } else {
            field.style.borderColor = '';
          }
        });
      }
      
      if (!isValid && message) {
        alert(message);
      }
      
      return isValid;
    }
    
    // Generate Lesson Outline
    function generateLessonOutline() {
      if (!validateCurrentFlow(3)) {
        return;
      }
      
      trackEvent('action', 'generate_outline', 'User generated lesson outline');
      autoSaveData();
      
      document.getElementById(`flow${currentFlow}`).classList.remove('active');
      currentFlow = 4;
      document.getElementById(`flow${currentFlow}`).classList.add('active');
      updateProgressBar();
      window.scrollTo(0, 0);
    }
    
    // Open ChatGPT with pre-filled query
    function openChatGPT() {
      const topic = document.getElementById('topic').value || 'lesson topic';
      const grade = document.getElementById('grade').value || 'Grade 8';
      const subject = document.getElementById('subject').value || 'subject';
      const lessonType = document.getElementById('lessonType').value || 'lesson type';
      const outcomes = document.getElementById('outcomes').value || 'lesson outcomes';
      const duration = document.getElementById('duration').value || '45 minutes';
      
      const query = `You are an expert English lesson planner. Create a detailed lesson plan for teaching "${topic}" in ${subject} (${lessonType}) for ${grade}. Lesson duration: ${duration}.

IMPORTANT FORMATTING INSTRUCTIONS:
You MUST structure your response EXACTLY as shown below. Use ONLY these section names and labels:

INTRODUCTION SECTION
TEACHER ACTIVITIES: [Detailed teacher activities for introduction. Start with "Teacher:" and use bullet points with "-" for each activity.]
LEARNER ACTIVITIES: [Detailed learner activities for introduction. Start with "Learners:" and use bullet points with "-" for each activity.]

PRESENTATION SECTION
TEACHER ACTIVITIES: [Detailed teacher activities for presentation. Start with "Teacher:" and use bullet points with "-" for each activity.]
LEARNER ACTIVITIES: [Detailed learner activities for presentation. Start with "Learners:" and use bullet points with "-" for each activity.]

PRACTICE SECTION
TEACHER ACTIVITIES: [Detailed teacher activities for practice. Start with "Teacher:" and use bullet points with "-" for each activity.]
LEARNER ACTIVITIES: [Detailed learner activities for practice. Start with "Learners:" and use bullet points with "-" for each activity.]

PRODUCTION SECTION
TEACHER ACTIVITIES: [Detailed teacher activities for production. Start with "Teacher:" and use bullet points with "-" for each activity.]
LEARNER ACTIVITIES: [Detailed learner activities for production. Start with "Learners:" and use bullet points with "-" for each activity.]

CONCLUSION SECTION
TEACHER ACTIVITIES: [Detailed teacher activities for conclusion. Start with "Teacher:" and use bullet points with "-" for each activity.]
LEARNER ACTIVITIES: [Detailed learner activities for conclusion. Start with "Learners:" and use bullet points with "-" for each activity.]

Additional context:
- Lesson type: ${lessonType}
- Specific outcomes: ${outcomes}
- Duration: ${duration}
- Include hands-on, interactive activities
- Make it practical for classroom implementation`;

      const url = `https://chat.openai.com/?q=${encodeURIComponent(query)}`;
      window.open(url, '_blank');
      trackEvent('action', 'open_chatgpt', `Topic: ${topic}`);
    }
    
    // Process with circular progress
    function processExplanationWithProgress() {
      const explanation = document.getElementById('chatgptExplanation').value.trim();
      if (!explanation) {
        alert('Please paste the ChatGPT explanation first.');
        return;
      }
      
      trackEvent('action', 'process_chatgpt', 'User processed ChatGPT explanation');
      
      // Show progress overlay
      const overlay = document.getElementById('progressOverlay');
      const progressCircle = document.getElementById('progressCircle');
      const progressPercent = document.getElementById('progressPercent');
      const progressText = document.getElementById('progressText');
      
      overlay.style.display = 'flex';
      let progress = 0;
      
      const interval = setInterval(() => {
        progress += 1;
        const percent = Math.min(progress, 100);
        progressPercent.textContent = `${percent}%`;
        progressCircle.style.background = `conic-gradient(#2b5dab ${percent * 3.6}deg, #e9ecef 0deg)`;
        
        if (progress >= 100) {
          clearInterval(interval);
          progressText.textContent = 'Processing complete!';
          
          setTimeout(() => {
            try {
              const sections = extractSectionsWithRegex(explanation);
              
              if (validateSections(sections)) {
                fillTableFromSections(sections);
                overlay.style.display = 'none';
                alert('‚úì Table filled successfully! All 10 cells updated.');
                trackEvent('action', 'table_filled_success', 'ChatGPT explanation successfully filled table');
              } else {
                const fallbackSections = extractSectionsFallback(explanation);
                if (validateSections(fallbackSections)) {
                  fillTableFromSections(fallbackSections);
                  overlay.style.display = 'none';
                  alert('‚úì Table filled using alternative parsing.');
                  trackEvent('action', 'table_filled_fallback', 'Used fallback parsing method');
                } else {
                  throw new Error('Could not extract all sections');
                }
              }
            } catch (error) {
              overlay.style.display = 'none';
              alert('‚ö†Ô∏è Format not recognized. Please ensure you copied the EXACT format from ChatGPT.');
              trackEvent('error', 'chatgpt_format_error', 'ChatGPT format not recognized');
            }
          }, 500);
        }
      }, 200);
    }
    
    // Extract sections with REGEX
    function extractSectionsWithRegex(text) {
      text = cleanText(text);
      
      const sections = {
        'introduction': { teacher: '', student: '' },
        'presentation': { teacher: '', student: '' },
        'practice': { teacher: '', student: '' },
        'production': { teacher: '', student: '' },
        'conclusion': { teacher: '', student: '' }
      };
      
      const patterns = {
        'introduction': /INTRODUCTION[^a-zA-Z]*(?:SECTION)?[^a-zA-Z]*TEACHER[^a-zA-Z]*ACTIVITIES[^a-zA-Z]*:([\s\S]*?)LEARNER[^a-zA-Z]*ACTIVITIES[^a-zA-Z]*:([\s\S]*?)(?=PRESENTATION|PRACTICE|PRODUCTION|CONCLUSION|$)/i,
        'presentation': /PRESENTATION[^a-zA-Z]*(?:SECTION)?[^a-zA-Z]*TEACHER[^a-zA-Z]*ACTIVITIES[^a-zA-Z]*:([\s\S]*?)LEARNER[^a-zA-Z]*ACTIVITIES[^a-zA-Z]*:([\s\S]*?)(?=PRACTICE|PRODUCTION|CONCLUSION|INTRODUCTION|$)/i,
        'practice': /PRACTICE[^a-zA-Z]*(?:SECTION)?[^a-zA-Z]*TEACHER[^a-zA-Z]*ACTIVITIES[^a-zA-Z]*:([\s\S]*?)LEARNER[^a-zA-Z]*ACTIVITIES[^a-zA-Z]*:([\s\S]*?)(?=PRODUCTION|CONCLUSION|INTRODUCTION|PRESENTATION|$)/i,
        'production': /PRODUCTION[^a-zA-Z]*(?:SECTION)?[^a-zA-Z]*TEACHER[^a-zA-Z]*ACTIVITIES[^a-zA-Z]*:([\s\S]*?)LEARNER[^a-zA-Z]*ACTIVITIES[^a-zA-Z]*:([\s\S]*?)(?=CONCLUSION|INTRODUCTION|PRESENTATION|PRACTICE|$)/i,
        'conclusion': /CONCLUSION[^a-zA-Z]*(?:SECTION)?[^a-zA-Z]*TEACHER[^a-zA-Z]*ACTIVITIES[^a-zA-Z]*:([\s\S]*?)LEARNER[^a-zA-Z]*ACTIVITIES[^a-zA-Z]*:([\s\S]*?)$/i
      };
      
      for (const [section, pattern] of Object.entries(patterns)) {
        const match = text.match(pattern);
        if (match && match.length >= 3) {
          sections[section].teacher = cleanExtractedText(match[1]);
          sections[section].student = cleanExtractedText(match[2]);
        }
      }
      
      if (!validateSections(sections)) {
        return extractSectionsBySequence(text);
      }
      
      return sections;
    }
    
    // Clean extracted text
    function cleanExtractedText(text) {
      if (!text) return '';
      
      return text
        .replace(/\n+/g, ' ')
        .replace(/\s+/g, ' ')
        .replace(/^[:\-\s]+/, '')
        .replace(/[:\-\s]+$/, '')
        .replace(/\b(Teacher|Learner|Student)\s+Activities?\s*:/gi, '')
        .trim();
    }
    
    // Extract by sequence
    function extractSectionsBySequence(text) {
      const sections = {
        'introduction': { teacher: '', student: '' },
        'presentation': { teacher: '', student: '' },
        'practice': { teacher: '', student: '' },
        'production': { teacher: '', student: '' },
        'conclusion': { teacher: '', student: '' }
      };
      
      const parts = text.split(/(INTRODUCTION|PRESENTATION|PRACTICE|PRODUCTION|CONCLUSION)/gi);
      
      let currentSection = null;
      
      for (let i = 0; i < parts.length; i++) {
        const part = parts[i].trim();
        if (!part) continue;
        
        const lowerPart = part.toLowerCase();
        if (lowerPart.includes('introduction')) {
          currentSection = 'introduction';
          continue;
        } else if (lowerPart.includes('presentation')) {
          currentSection = 'presentation';
          continue;
        } else if (lowerPart.includes('practice')) {
          currentSection = 'practice';
          continue;
        } else if (lowerPart.includes('production')) {
          currentSection = 'production';
          continue;
        } else if (lowerPart.includes('conclusion')) {
          currentSection = 'conclusion';
          continue;
        }
        
        if (currentSection && part) {
          const split = splitTeacherStudentSmart(part);
          if (split.teacher) {
            sections[currentSection].teacher += ' ' + split.teacher;
          }
          if (split.student) {
            sections[currentSection].student += ' ' + split.student;
          }
        }
      }
      
      for (const section in sections) {
        sections[section].teacher = cleanText(sections[section].teacher);
        sections[section].student = cleanText(sections[section].student);
      }
      
      return sections;
    }
    
    // Smart teacher/student split
    function splitTeacherStudentSmart(text) {
      const result = { teacher: '', student: '' };
      
      const sentences = text.split(/[.!?]+/).filter(s => s.trim());
      
      sentences.forEach(sentence => {
        const lower = sentence.toLowerCase();
        
        const teacherIndicators = [
          'teacher will', 'teacher explains', 'teacher demonstrates', 'teacher shows',
          'teacher presents', 'teacher models', 'teacher asks', 'teacher writes'
        ];
        
        const studentIndicators = [
          'students will', 'students practice', 'students work', 'students complete',
          'students answer', 'students respond', 'students write', 'students read',
          'learners will', 'learners practice', 'learners work', 'learners complete'
        ];
        
        let teacherScore = 0;
        let studentScore = 0;
        
        teacherIndicators.forEach(indicator => {
          if (lower.includes(indicator)) teacherScore++;
        });
        
        studentIndicators.forEach(indicator => {
          if (lower.includes(indicator)) studentScore++;
        });
        
        if (teacherScore > studentScore) {
          result.teacher += sentence.trim() + '. ';
        } else if (studentScore > teacherScore) {
          result.student += sentence.trim() + '. ';
        } else {
          result.teacher += sentence.trim() + '. ';
        }
      });
      
      result.teacher = cleanText(result.teacher);
      result.student = cleanText(result.student);
      
      return result;
    }
    
    // Validate sections
    function validateSections(sections) {
      let filledCount = 0;
      const requiredFields = 10;
      
      for (const section in sections) {
        if (sections[section].teacher && sections[section].teacher.trim().length > 10) {
          filledCount++;
        }
        if (sections[section].student && sections[section].student.trim().length > 10) {
          filledCount++;
        }
      }
      
      return filledCount >= requiredFields * 0.7;
    }
    
    // Fallback extraction
    function extractSectionsFallback(text) {
      return extractSectionsBySequence(text);
    }
    
    // Clean text
    function cleanText(text) {
      if (!text) return '';
      return text
        .replace(/\s+/g, ' ')
        .trim();
    }
    
    // Format activities
    function formatActivitiesWithBullets(text, role) {
      if (!text) return '';
      
      text = text.replace(/^(Teacher|Learners):\s*/i, '');
      
      const sentences = text.split(/(?<=\.)\s+/).filter(s => s.trim());
      
      let formatted = `${role}: `;
      sentences.forEach((sentence, index) => {
        const trimmed = sentence.trim();
        if (trimmed) {
          if (index === 0) {
            formatted += `- ${trimmed}`;
          } else {
            formatted += `\n- ${trimmed}`;
          }
        }
      });
      
      return formatted;
    }
    
    // Fill table with extracted sections
    function fillTableFromSections(sections) {
      const mapping = {
        'introduction': { teacher: 'introTeacher', student: 'introStudent' },
        'presentation': { teacher: 'presentTeacher', student: 'presentStudent' },
        'practice': { teacher: 'practiceTeacher', student: 'practiceStudent' },
        'production': { teacher: 'productionTeacher', student: 'productionStudent' },
        'conclusion': { teacher: 'conclusionTeacher', student: 'conclusionStudent' }
      };
      
      for (const [section, fields] of Object.entries(mapping)) {
        const teacherField = document.getElementById(fields.teacher);
        const studentField = document.getElementById(fields.student);
        
        if (teacherField && sections[section].teacher) {
          teacherField.value = formatActivitiesWithBullets(sections[section].teacher, 'Teacher');
        }
        
        if (studentField && sections[section].student) {
          studentField.value = formatActivitiesWithBullets(sections[section].student, 'Learners');
        }
      }
    }
    
    // Manual save function
    function saveAllData() {
      const planData = collectAllData();
      localStorage.setItem('lessonPlanData', JSON.stringify(planData));
      alert('‚úÖ All data saved successfully!');
      trackEvent('action', 'save_data', 'User saved lesson plan data');
    }
    
    // Collect all form and table data
    function collectAllData() {
      const formData = {};
      const formElements = document.querySelectorAll('input[type="text"], textarea');
      
      formElements.forEach(element => {
        if (element.id) {
          formData[element.id] = element.value;
        }
      });
      
      return formData;
    }
    
    // Generate PDF function
    function generatePDF() {
      const data = collectAllData();
      
      trackEvent('action', 'generate_pdf', `Subject: ${data.subject || 'Unknown'}`);
      
      const doc = new jsPDF({
        orientation: 'landscape',
        unit: 'mm',
        format: 'a4'
      });
      
      doc.setFont('times');
      doc.setFontSize(12);
      
      const pageWidth = 297;
      const pageHeight = 210;
      const leftMargin = 20;
      const rightMargin = 15;
      const topMargin = 15;
      const contentWidth = pageWidth - leftMargin - rightMargin;
      
      // Header
      doc.setFontSize(16);
      doc.setFont('times', 'bold');
      doc.text('LESSON PLAN', pageWidth / 2, topMargin + 5, { align: 'center' });
      
      let y = topMargin + 15;
      
      // School Information
      doc.setFontSize(12);
      doc.setFont('times', 'bold');
      doc.text('SCHOOL:', leftMargin, y);
      doc.setFont('times', 'normal');
      doc.text(data.schoolName || '', leftMargin + 25, y);
      
      doc.setFont('times', 'bold');
      doc.text("TR'S NAME:", leftMargin + contentWidth/2, y);
      doc.setFont('times', 'normal');
      doc.text(data.teacher || '', leftMargin + contentWidth/2 + 25, y);
      
      y += 7;
      doc.setFont('times', 'bold');
      doc.text('GRADE:', leftMargin, y);
      doc.setFont('times', 'normal');
      doc.text(data.grade || '', leftMargin + 25, y);
      
      doc.setFont('times', 'bold');
      doc.text('SUBJECT:', leftMargin + contentWidth/3, y);
      doc.setFont('times', 'normal');
      doc.text(data.subject || '', leftMargin + contentWidth/3 + 25, y);
      
      doc.setFont('times', 'bold');
      doc.text('LESSON TYPE:', leftMargin + 2*contentWidth/3, y);
      doc.setFont('times', 'normal');
      doc.text(data.lessonType || '', leftMargin + 2*contentWidth/3 + 30, y);
      
      y += 7;
      doc.setFont('times', 'bold');
      doc.text('LESSON:', leftMargin, y);
      doc.setFont('times', 'normal');
      doc.text(data.topic || '', leftMargin + 25, y);
      
      y += 7;
      doc.setFont('times', 'bold');
      doc.text('DATE:', leftMargin, y);
      doc.setFont('times', 'normal');
      doc.text(data.date || '', leftMargin + 25, y);
      
      doc.setFont('times', 'bold');
      doc.text('TIME:', leftMargin + contentWidth/3, y);
      doc.setFont('times', 'normal');
      doc.text(data.time || '', leftMargin + contentWidth/3 + 20, y);
      
      doc.setFont('times', 'bold');
      doc.text('DURATION:', leftMargin + 2*contentWidth/3, y);
      doc.setFont('times', 'normal');
      doc.text(data.duration || '45 minutes', leftMargin + 2*contentWidth/3 + 30, y);
      
      // Methods and References
      y += 10;
      doc.setFont('times', 'bold');
      doc.text('METHODS:', leftMargin, y);
      doc.setFont('times', 'normal');
      const methodsLines = doc.splitTextToSize(data.methods || '', contentWidth - 30);
      methodsLines.forEach((line, index) => {
        doc.text(line, leftMargin + 25, y + (index * 5));
      });
      y += methodsLines.length * 5;
      
      y += 5;
      doc.setFont('times', 'bold');
      doc.text('REFERENCE:', leftMargin, y);
      doc.setFont('times', 'normal');
      const refLines = doc.splitTextToSize(data.references || '', contentWidth - 35);
      refLines.forEach((line, index) => {
        doc.text(line, leftMargin + 30, y + (index * 5));
      });
      y += refLines.length * 5;
      
      y += 5;
      doc.setFont('times', 'bold');
      doc.text('TL/ AIDS:', leftMargin, y);
      doc.setFont('times', 'normal');
      const aidsLines = doc.splitTextToSize(data.aids || '', contentWidth - 30);
      aidsLines.forEach((line, index) => {
        doc.text(line, leftMargin + 30, y + (index * 5));
      });
      y += aidsLines.length * 5;
      
      // Specific Outcomes
      y += 10;
      doc.setFont('times', 'bold');
      doc.text('SPECIFIC OUTCOMES:', leftMargin, y);
      doc.setFont('times', 'normal');
      const outcomeLines = doc.splitTextToSize(data.outcomes || '', contentWidth - 45);
      outcomeLines.forEach((line, index) => {
        doc.text(line, leftMargin + 45, y + (index * 5));
      });
      y += outcomeLines.length * 5 + 10;
      
      // Draw a line before the table
      doc.line(leftMargin, y, pageWidth - rightMargin, y);
      y += 5;
      
      // Lesson Outline Table Title
      doc.setFontSize(14);
      doc.setFont('times', 'bold');
      doc.text('LESSON OUTLINE', pageWidth / 2, y, { align: 'center' });
      y += 10;
      
      // Prepare table data
      const tableData = [
        [
          'INTRODUCTION', 
          data.introTeacher || '',
          data.introStudent || '',
          '5 min'
        ],
        [
          'PRESENTATION', 
          data.presentTeacher || '',
          data.presentStudent || '',
          '15 min'
        ],
        [
          'PRACTICE', 
          data.practiceTeacher || '',
          data.practiceStudent || '',
          '10 min'
        ],
        [
          'PRODUCTION', 
          data.productionTeacher || '',
          data.productionStudent || '',
          '10 min'
        ],
        [
          'CONCLUSION', 
          data.conclusionTeacher || '',
          data.conclusionStudent || '',
          '5 min'
        ]
      ];
      
      // Create table using autoTable
      doc.autoTable({
        startY: y,
        head: [['STAGES', 'TEACHER\'S ACTIVITIES', 'LEARNER\'S ACTIVITIES', 'TIME']],
        body: tableData,
        theme: 'grid',
        styles: { 
          font: 'times',
          fontSize: 10,
          cellPadding: 3,
          lineColor: [0, 0, 0],
          lineWidth: 0.2,
          overflow: 'linebreak',
          halign: 'left',
          textColor: [0, 0, 0]
        },
        headStyles: { 
          fillColor: [43, 93, 171],
          textColor: [255, 255, 255],
          fontStyle: 'bold',
          halign: 'center',
          fontSize: 11
        },
        columnStyles: {
          0: { cellWidth: 30, halign: 'center', fontStyle: 'bold' },
          1: { cellWidth: (contentWidth - 70) / 2 + 10, fontSize: 10 },
          2: { cellWidth: (contentWidth - 70) / 2 + 10, fontSize: 10 },
          3: { cellWidth: 20, halign: 'center' }
        },
        margin: { left: leftMargin, right: rightMargin },
        tableWidth: contentWidth + 10,
        pageBreak: 'auto',
        showHead: 'firstPage'
      });
      
      // Save PDF
      const fileName = `LessonPlan_${(data.subject || 'Subject').replace(/[^a-zA-Z0-9]/g, '_')}_${(data.date || 'Date').replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
      doc.save(fileName);
    }
  </script>
</body>
</html>